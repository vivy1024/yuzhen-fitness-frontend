# 技术架构概述

**状态**: ✅ 已完成  
**版本**: v1.0.0  
**更新日期**: 2026-01-07  
**作者**: 薛小川

---

## 系统概述

玉珍健身采用三端分离架构，由前端PWA、PHP后端、DAML-RAG服务三个独立服务组成，通过API协作提供完整的智能健身服务。

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户设备                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              前端PWA (Vue 3 + TypeScript)                │   │
│  │                    localhost:9000                        │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        服务端                                    │
│  ┌─────────────────────┐    ┌─────────────────────────────┐    │
│  │   PHP后端 (Laravel)  │    │   DAML-RAG服务 (Python)     │    │
│  │   localhost:8000     │◄──►│   localhost:8001            │    │
│  │                      │    │                             │    │
│  │  • 用户认证          │    │  • AI对话                   │    │
│  │  • 数据持久化        │    │  • 训练计划生成             │    │
│  │  • 会员管理          │    │  • 知识图谱查询             │    │
│  │  • 订单处理          │    │  • 安全评估                 │    │
│  └─────────────────────┘    └─────────────────────────────┘    │
│              │                           │                      │
│              ▼                           ▼                      │
│  ┌─────────────────────┐    ┌─────────────────────────────┐    │
│  │       MySQL         │    │   Neo4j + Qdrant + Redis    │    │
│  │   用户数据/订单      │    │   知识图谱/向量库/缓存       │    │
│  └─────────────────────┘    └─────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
```

---

## 三端职责

### 前端PWA (Vue 3)

**技术栈**: Vue 3 + TypeScript + Pinia + shadcn-vue + Tailwind CSS

**核心职责**:
- 用户界面渲染和交互
- 状态管理（Pinia）
- 流式响应处理（SSE）
- PWA离线支持
- 本地缓存（IndexedDB）

**主要功能**:
| 模块 | 功能 | 对接服务 |
|------|------|----------|
| AI聊天 | 流式对话、工具调用展示 | DAML-RAG |
| 动作库 | 动作浏览、搜索、筛选 | PHP后端 |
| 食物库 | 食物浏览、营养查询 | PHP后端 |
| 训练计划 | 计划管理、训练记录 | PHP后端 |
| 用户中心 | 登录注册、档案管理 | PHP后端 |

### PHP后端 (Laravel)

**技术栈**: Laravel 10 + MySQL + Redis

**核心职责**:
- 用户认证和授权（JWT）
- 业务数据持久化
- 会员订单管理
- 文件存储（动作图片等）
- API网关

**主要功能**:
| 模块 | 功能 | 数据存储 |
|------|------|----------|
| 认证 | 登录、注册、Token刷新 | MySQL |
| 用户档案 | 身体数据、训练偏好 | MySQL |
| 训练计划 | 计划CRUD、训练记录 | MySQL |
| 会员系统 | 订单、支付、权限 | MySQL |
| 动作/食物 | 数据查询、图片服务 | MySQL + 文件系统 |

### DAML-RAG服务 (Python)

**技术栈**: FastAPI + LangChain + Neo4j + Qdrant

**核心职责**:
- AI对话处理
- 知识图谱查询
- 向量检索
- MCP工具调用
- 训练计划生成

**主要功能**:
| 模块 | 功能 | 数据存储 |
|------|------|----------|
| 对话引擎 | 意图识别、响应生成 | Redis（会话） |
| 三层检索 | 向量→图谱→约束 | Qdrant + Neo4j |
| DAG编排 | 工具调用、流程控制 | 内存 |
| MCP工具 | 18个专业健身工具 | Neo4j |

---

## 数据流

### AI对话流程

```
用户输入
    │
    ▼
┌─────────────────┐
│   前端PWA       │  1. 发送消息到DAML-RAG
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  DAML-RAG服务   │  2. 意图识别 → DAG选择 → 工具调用
│                 │  3. 三层检索（向量→图谱→约束）
│                 │  4. LLM生成响应
└────────┬────────┘
         │
         ▼ (SSE流式响应)
┌─────────────────┐
│   前端PWA       │  5. 实时渲染响应
└─────────────────┘
```

### 训练计划导入流程

```
AI生成训练计划
    │
    ▼
┌─────────────────┐
│   前端PWA       │  1. 用户点击"导入计划"
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   PHP后端       │  2. 保存计划到MySQL
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   前端PWA       │  3. 跳转到训练计划页面
└─────────────────┘
```

---

## 核心数据统计

### 数据规模

| 数据类型 | 数量 | 存储位置 |
|----------|------|----------|
| 健身动作 | 1,790+ | MySQL + Neo4j |
| 肌肉群 | 40 | Neo4j |
| 食物数据 | 1,880+ | MySQL |
| AI场景 | 13 | DAML-RAG配置 |
| MCP工具 | 18 | DAML-RAG |
| DAG模板 | 13 | DAML-RAG |

### 知识图谱

| 指标 | 数值 |
|------|------|
| Neo4j节点 | 4,246 |
| Neo4j关系 | 61,507 |
| Qdrant向量 | 3,684 |
| 向量维度 | 1024 (GTE-Large-zh) |

### 系统评分

| 指标 | 评分 |
|------|------|
| 综合评分 | 92.5/100 |
| 数据完整性 | 95% |
| API响应时间 | <200ms |
| AI响应TTFB | <1s |

---

## 部署架构

### Docker容器

| 服务 | 容器名 | 端口 |
|------|--------|------|
| DAML-RAG | fitness_daml_rag | 8001 |
| PHP后端 | fitness_php_v2 | 9000 (FPM) |
| Nginx | fitness_nginx | 8000 |
| MySQL | fitness_mysql | 3306 |
| Neo4j | fitness_neo4j | 7474/7687 |
| Qdrant | fitness_qdrant | 6333/6334 |
| Redis | fitness_redis | 6379 |

### 前端部署

前端PWA独立部署，可选方案：
- 本地开发：`npm run dev` (localhost:9000)
- 生产部署：Nginx静态托管 / Vercel / Netlify

---

## 相关文档

- [系统架构总览](./01-系统架构总览.md)
- [与DAML-RAG集成架构](./02-与DAML-RAG集成架构.md)
- [用户档案数据映射](./03-用户档案数据映射.md)
